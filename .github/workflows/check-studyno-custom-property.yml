name: Check StudyNo custom property

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-studyno:
    runs-on: ubuntu-latest
    steps:
      - name: Get StudyNo custom property
        id: get_prop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          # REST API を使用してカスタムプロパティを取得
          RESPONSE=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$OWNER/$REPO/properties/values")

          echo "API response:"
          echo "$RESPONSE"

          # JSON を解析して StudyNo の値を取得
          # 注意：データ構造はオブジェクト配列です。property_name が "StudyNo" の項目を見つける必要があります
          STUDY_NO=$(echo "$RESPONSE" | jq -r '.[] | select(.property_name == "StudyNo") | .value // empty')

          if [ -z "$STUDY_NO" ]; then
            echo "::error ::Custom property StudyNo is missing or empty"
            exit 1
          fi

          echo "StudyNo=$STUDY_NO" >> $GITHUB_ENV

      - name: Success message
        run: |
          echo "✅ Custom property StudyNo exists"
          echo "StudyNo value: $StudyNo"
